import{L as e,d as s,r as a,v as o,q as t,h as i,j as l,o as n,c as u,w as r,e as c,F as d,f,n as m,a as p,b as v,t as y,p as _,u as b,z as h,x as w,l as g,i as k,g as F,X as C,A as T,I as z,ac as x}from"./index-3f88d4b2.js";import{g as L,K as P,m as D,h as I,i as j,t as A,c as E,P as S,W as U,F as K,Q as M,o as N,b as R}from"./page-wraper.84820f31.js";import{u as O}from"./useTranslate.23fa9f56.js";const X=R(s({name:"wd-upload",options:{addGlobalClass:!0,virtualHost:!0,styleIsolation:"shared"},props:{...L,fileList:P(),action:D(""),header:{type:Object,default:()=>{}},multiple:I(!1),disabled:I(!1),limit:j(0),showLimitNum:I(!0),maxSize:j(Number.MAX_VALUE),sourceType:{type:Array,default:()=>["album","camera"]},sizeType:{type:Array,default:()=>["original","compressed"]},name:D("file"),formData:{type:Object,default:()=>{}},onPreviewFail:Function,beforeUpload:Function,beforeChoose:Function,beforeRemove:Function,beforePreview:Function,buildFormData:Function,loadingType:D("ring"),loadingColor:D("#ffffff"),accept:D("image"),statusKey:D("status"),useDefaultSlot:I(!1),loadingSize:D("24px"),customEvokeClass:D(""),customPreviewClass:D(""),imageMode:D("aspectFit")},emits:["fail","change","success","progress","oversize","chooseerror","remove"],setup(s,{emit:L}){const P=s,{translate:D}=O("upload"),I=a([]),j=o((()=>!P.limit||I.value.length<P.limit));function R(e,s,a){const{statusKey:o}=P,t=I.value.findIndex((e=>e.uid===s.uid));t>-1&&(I.value[t][o]="fail",I.value[t].error=e.message,I.value[t].response=e,L("fail",{error:e,file:s,formData:a}))}function X(e,s){const{action:a,name:o,header:t={},accept:i}=P;x({url:a,header:t,name:o,fileName:o,fileType:i,formData:s,filePath:e.url,success(a){200===a.statusCode?function(e,s,a){const{statusKey:o}=P,t=I.value.findIndex((e=>e.uid===s.uid));t>-1&&(I.value[t][o]="success",I.value[t].response=e.data,L("change",{fileList:I.value}),L("success",{file:s,fileList:I.value,formData:a}))}(a,e,s):R(a,e,s)},fail(a){R(a,e,s)}}).onProgressUpdate((s=>{!function(e,s){const a=I.value.findIndex((e=>e.uid===s.uid));a>-1&&(I.value[a].percent=e.progress,L("progress",{response:e,file:s}))}(s,e)}))}function $(){const{multiple:s,maxSize:a,accept:o,sizeType:t,limit:i,sourceType:l,beforeUpload:n}=P;"image"===o&&function({multiple:s,sizeType:a,sourceType:o,maxCount:t}){return new Promise(((i,l)=>{e({count:s?Math.min(t,9):1,sizeType:a,sourceType:o,success:i,fail:l})}))}({multiple:s,sizeType:t,sourceType:l,maxCount:i?i-I.value.length:9}).then((e=>{let o=Array.prototype.slice.call(e.tempFiles);s||(o=o.slice(0,1));const t=e=>{e.forEach((async e=>{var s;N(e.size)||(e.size=await(s=e.path,new Promise(((e,a)=>{z({src:s,success:s=>{e(s.height*s.width)},fail:()=>{a(0)}})})))),e.size<=a?function(e){const s={uid:U.id++,name:e.name||"",status:"loading",size:e.size,url:e.path,action:P.action,percent:0};I.value.push(s);const{buildFormData:a,formData:o={}}=P;a?a({file:s,formData:o,resolve:e=>{e&&X(s,e)}}):X(s,o)}(e):L("oversize",{file:e})}))};n?n({files:o,fileList:I.value,resolve:e=>{e&&t(o)}}):t(o)})).catch((e=>{L("chooseerror",{error:e})}))}function q(){if(P.disabled)return;const{beforeChoose:e}=P;e?e({fileList:I.value,resolve:e=>{e&&$()}}):$()}function G(e,s){I.value.splice(I.value.findIndex((s=>s.uid===e.uid)),1),L("change",{fileList:I.value}),L("remove",{file:e})}function H(e,s){const{onPreviewFail:a}=P;C({urls:s,current:s[e],fail(){a?a({index:e,imgList:s}):T({title:"预览图片失败",icon:"none"})}})}return t((()=>P.fileList),(e=>{const{statusKey:s}=P;if(S(e,I.value))return;const a=e.map((e=>(e.uid=U.id++,e[s]=e[s]||"success",e.action=P.action||"",e.response=e.response||"",e)));I.value=a}),{deep:!0,immediate:!0}),t((()=>P.limit),(e=>{e&&e<I.value.length&&console.error("[wot-design]Error: props limit must less than fileList.length")}),{deep:!0,immediate:!0}),t((()=>P.beforePreview),(e=>{e&&!K(e)&&"asyncfunction"!==M(e)&&console.error("The type of beforePreview must be Function")}),{deep:!0,immediate:!0}),t((()=>P.onPreviewFail),(e=>{e&&!K(e)&&"asyncfunction"!==M(e)&&console.error("The type of onPreviewFail must be Function")}),{deep:!0,immediate:!0}),t((()=>P.beforeRemove),(e=>{e&&!K(e)&&"asyncfunction"!==M(e)&&console.error("The type of beforeRemove must be Function")}),{deep:!0,immediate:!0}),t((()=>P.beforeUpload),(e=>{e&&!K(e)&&"asyncfunction"!==M(e)&&console.error("The type of beforeUpload must be Function")}),{deep:!0,immediate:!0}),t((()=>P.beforeChoose),(e=>{e&&!K(e)&&"asyncfunction"!==M(e)&&console.error("The type of beforeChoose must be Function")}),{deep:!0,immediate:!0}),t((()=>P.buildFormData),(e=>{e&&!K(e)&&"asyncfunction"!==M(e)&&console.error("The type of buildFormData must be Function")}),{deep:!0,immediate:!0}),(e,s)=>{const a=g,o=k,t=i(l("wd-loading"),A),C=F,T=i(l("wd-icon"),E);return n(),u(o,{class:m(["wd-upload",e.customClass]),style:w(e.customStyle)},{default:r((()=>[(n(!0),c(d,null,f(I.value,((s,i)=>(n(),u(o,{class:m(["wd-upload__preview",e.customPreviewClass]),key:i},{default:r((()=>[p(o,{class:"wd-upload__status-content"},{default:r((()=>[p(a,{src:s.url,mode:e.imageMode,class:"wd-upload__picture",onClick:e=>function(e){const{beforePreview:s}=P,a=I.value.map((e=>e.url));s?s({index:e,imgList:a,resolve:s=>{s&&H(e,a)}}):H(e,a)}(i)},null,8,["src","mode","onClick"])])),_:2},1024),"success"!==s.status?(n(),u(o,{key:0,class:"wd-upload__mask wd-upload__status-content"},{default:r((()=>["loading"===s.status?(n(),u(o,{key:0,class:"wd-upload__status-content"},{default:r((()=>[p(t,{type:e.loadingType,size:e.loadingSize,color:e.loadingColor},null,8,["type","size","color"]),p(C,{class:"wd-upload__progress-txt"},{default:r((()=>[v(y(s.percent)+"%",1)])),_:2},1024)])),_:2},1024)):_("",!0),"fail"===s.status?(n(),u(o,{key:1,class:"wd-upload__status-content"},{default:r((()=>[p(T,{name:"close-outline","custom-class":"wd-upload__icon"}),p(C,{class:"wd-upload__progress-txt"},{default:r((()=>[v(y(s.error||b(D)("error")),1)])),_:2},1024)])),_:2},1024)):_("",!0)])),_:2},1024)):_("",!0),"loading"===s.status||e.disabled?_("",!0):(n(),u(T,{key:1,name:"error-fill","custom-class":"wd-upload__close",onClick:e=>function(e){const{beforeRemove:s}=P,a=e,o=I.value[a];s?s({file:o,index:a,fileList:I.value,resolve:e=>{e&&G(o)}}):G(o)}(i)},null,8,["onClick"]))])),_:2},1032,["class"])))),128)),b(j)?(n(),c(d,{key:0},[e.$slots.default?(n(),u(o,{key:0,class:m(["wd-upload__evoke-slot",e.customEvokeClass]),onClick:q},{default:r((()=>[h(e.$slots,"default",{},void 0,!0)])),_:3},8,["class"])):(n(),u(o,{key:1,onClick:q,class:m(["wd-upload__evoke",e.disabled?"is-disabled":"",e.customEvokeClass])},{default:r((()=>[p(T,{class:"wd-upload__evoke-icon",name:"fill-camera"}),e.limit&&e.showLimitNum?(n(),u(o,{key:0,class:"wd-upload__evoke-num"},{default:r((()=>[v("（"+y(I.value.length)+"/"+y(e.limit)+"）",1)])),_:1})):_("",!0)])),_:1},8,["class"]))],64)):_("",!0)])),_:3},8,["class","style"])}}}),[["__scopeId","data-v-0835bc5b"]]);export{X as _};
